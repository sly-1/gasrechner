<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GasZ√§hler Pro v8.3.22</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --ios-blue: #007AFF; 
            --ios-red: #FF3B30; 
            --ios-bg: #F2F2F7; 
            --ios-card: #FFFFFF; 
            --ios-text-secondary: #8E8E93; 
            --ios-green: #34C759; 
            --ios-orange: #FF9500; 
            --ios-gray: #E5E5EA; 
            --ios-neutral: #D1D1D6; 
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: var(--ios-bg); 
            margin: 0; 
            padding: 20px; 
            color: #000; 
            -webkit-font-smoothing: antialiased; 
        }

        /* Lockscreen */
        #lockScreen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--ios-bg); z-index: 10000; display: none; 
            flex-direction: column; align-items: center; justify-content: center; 
        }

        .pin-input { 
            font-size: 28px; padding: 15px; width: 180px; text-align: center; 
            border-radius: 15px; border: 2px solid var(--ios-neutral); margin-bottom: 20px; 
        }

        /* Cards */
        .card { 
            background: var(--ios-card); padding: 18px; border-radius: 14px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.04); margin-bottom: 15px; 
            border-left: 6px solid var(--ios-neutral); transition: border-color 0.4s; 
        }

        label { 
            display: block; margin-bottom: 5px; font-size: 11px; 
            color: var(--ios-text-secondary); text-transform: uppercase; font-weight: 700; 
        }

        /* INPUT FIX: iOS Symmetrie */
        input, textarea, select { 
            width: 100% !important; 
            max-width: 100% !important;
            padding: 12px; border: 1px solid var(--ios-neutral); 
            border-radius: 10px; font-size: 16px; margin-bottom: 10px; 
            font-family: inherit; display: block; background: #fff;
            -webkit-appearance: none; appearance: none;
        }

        .settings-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; 
        }

        .full-width { 
            grid-column: span 2; 
        }

        /* Buttons */
        button { 
            width: 100%; max-width: 340px; display: block; margin: 12px auto; 
            background: var(--ios-blue); color: white; border: none; 
            padding: 16px; border-radius: 12px; font-size: 17px; 
            font-weight: 600; cursor: pointer; 
        }

        .btn-small { 
            background: var(--ios-gray); color: #000; padding: 12px; 
            font-size: 14px; flex: 1; border-radius: 10px; border: none; 
        }

        /* Ampel & Badges */
        .badge { 
            display: inline-block; padding: 6px 14px; border-radius: 20px; 
            font-size: 12px; font-weight: 700; border: 1px solid transparent; 
            margin-top: 5px; 
        }

        .bg-good   { background: #E7F9ED; color: var(--ios-green); border-color: var(--ios-green); }
        .bg-danger { background: #FFEBEB; color: var(--ios-red); border-color: var(--ios-red); }
        .bg-warn   { background: #FFF4E5; color: var(--ios-orange); border-color: var(--ios-orange); }
        .bg-info   { background: #E5F1FF; color: var(--ios-blue); border-color: var(--ios-blue); }

        .result-main { 
            font-size: 34px; font-weight: 800; display: block; margin: 5px 0; 
            letter-spacing: -1px; 
        }

        /* Chart */
        .chart-container-outer { 
            position: relative; width: 100%; background: #fafafa; 
            border-radius: 10px; border: 1px solid var(--ios-gray); 
            height: 180px; overflow: hidden; margin-top: 10px; 
        }
        
        .y-axis-labels { 
            position: absolute; left: 0; top: 0; width: 45px; height: 100%; 
            background: #fafafa; z-index: 5; display: flex; flex-direction: column; 
            justify-content: space-between; padding: 15px 0 40px 5px; 
            font-size: 10px; color: var(--ios-text-secondary); border-right: 1px solid #eee; 
        }

        .chart-viewport { overflow-x: auto; margin-left: 45px; height: 100%; }
        .chart-wrapper { height: 160px; }

        /* History */
        .history-scroll { 
            max-height: 280px; overflow-y: auto; border-radius: 10px; 
            border: 1px solid var(--ios-gray); margin-top: 15px; 
        }
        
        table { width: 100%; border-collapse: collapse; background: #fff; }
        th { background: #fafafa; padding: 12px 8px; font-size: 11px; text-transform: uppercase; color: var(--ios-text-secondary); text-align: left; }
        td { padding: 14px 8px; font-size: 14px; border-bottom: 1px solid #f2f2f7; }
        
        .trend-up { color: var(--ios-red); font-weight: bold; }
        .trend-down { color: var(--ios-green); font-weight: bold; }

        #toast { 
            position: fixed; top: 40px; left: 50%; transform: translateX(-50%) translateY(-150px); 
            background: rgba(0,0,0,0.85); color: white; padding: 14px 28px; 
            border-radius: 30px; z-index: 10001; transition: transform 0.5s; 
        }
        #toast.visible { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <div id="lockScreen">
        <h2 style="color: #333;">Sicherheits-Check</h2>
        <input type="password" id="pinInput" class="pin-input" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <button onclick="unlockApp()">Entsperren</button>
    </div>

    <div id="toast">‚úÖ Z√§hlerstand gespeichert</div>

    <div id="main">
        <h1 style="display: flex; align-items: center; justify-content: center; gap: 12px;">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="var(--ios-orange)"><path d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.361-6.867 8.21 8.21 0 003 2.48z"/></svg>
            GasZ√§hler Pro v8.3.22
        </h1>

        <div class="card">
            <label>Ablesung</label>
            <div style="display: flex; gap: 10px;">
                <input type="date" id="newDate">
                <input type="number" id="newMeter" step="0.001" placeholder="Stand m¬≥" oninput="liveUpdate()">
            </div>
            
            <details style="margin-top: 10px;">
                <summary style="color:var(--ios-blue); font-size:13px; cursor:pointer; font-weight:700; padding: 5px 0;">‚öôÔ∏è Konfiguration</summary>
                <div style="margin-top:10px; border-top:1px solid #eee; padding-top:15px;">
                    <label>Preistabelle (Limit:Cent/kWh:Grundpreis)</label>
                    <textarea id="tiers" rows="2" oninput="liveUpdate()">6000:12.80:5.36&#10;99999:11.79:10.41</textarea>
                    
                    <div class="settings-grid">
                        <div><label>Brennwert</label><input type="number" id="bw" value="10.550" step="0.001" oninput="liveUpdate()"></div>
                        <div><label>z-Zahl</label><input type="number" id="zz" value="0.9500" step="0.0001" oninput="liveUpdate()"></div>
                        <div><label>Abschlag ‚Ç¨</label><input type="number" id="pay" value="150" oninput="liveUpdate()"></div>
                        <div><label>Start-m¬≥</label><input type="number" id="start" value="0" step="0.1" oninput="liveUpdate()"></div>
                        <div class="full-width"><label>Datum 1. Abschlagszahlung</label><input type="date" id="firstPayDate" oninput="liveUpdate()"></div>
                        <div class="full-width"><label>PIN-Sperre</label><input type="password" id="pinSetting" placeholder="Sicherheits-PIN" oninput="updatePin()"></div>
                    </div>
                </div>
            </details>
        </div>

        <div class="card" id="cardSaldo" style="text-align:center">
            <label>Finanz-Status (Aktuell)</label>
            <span class="result-main" id="outSaldo">0,00 ‚Ç¨</span>
            <div id="badgeSaldo" class="badge">Keine Daten</div>
        </div>

        <div class="card" id="cardTrend" style="text-align:center">
            <label>Jahres-Trend (Empfehlung)</label>
            <span class="result-main" id="outYear">0,00 ‚Ç¨</span>
            <div id="badgeTrend" class="badge">Warte auf Eingabe...</div>
        </div>

        <button id="saveBtn" onclick="doSave()">üíæ Aktuellen Stand sichern</button>

        <div class="card">
            <label>Verbrauchsverlauf</label>
            <div class="chart-container-outer">
                <div class="y-axis-labels"><span>Max</span><span>√ò</span><span>0</span></div>
                <div class="chart-viewport" id="chartView"><div class="chart-wrapper" id="chartWrap"><canvas id="mainChart"></canvas></div></div>
            </div>
            
            <div class="history-scroll">
                <table>
                    <thead><tr><th>Datum</th><th>Stand m¬≥</th><th>Trend</th><th>Aktion</th></tr></thead>
                    <tbody id="historyTable"></tbody>
                </table>
            </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn-small" onclick="doExport()">Export</button>
            <button class="btn-small" onclick="doImport()">Import</button>
        </div>
        <button class="btn-danger-text" onclick="doReset()" style="background:none; color:var(--ios-red); border:none; width:100%; margin-top:25px; font-weight:600;">‚ö†Ô∏è Alle Daten unwiderruflich l√∂schen</button>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('gas_db_v8')) || [];
        let myChart = null;

        // Hilfsfunktion Preisfindung
        function getActiveTier(kwh, tiers) {
            for (let t of tiers) {
                if (kwh <= t.limit) return t;
            }
            return tiers[tiers.length - 1];
        }

        function liveUpdate() {
            // Persistenz der Einstellungen
            ['bw', 'zz', 'pay', 'start', 'tiers', 'firstPayDate'].forEach(id => {
                localStorage.setItem('gas_pref_' + id, document.getElementById(id).value);
            });

            const cfg = {
                bw: parseFloat(document.getElementById('bw').value) || 10.55,
                zz: parseFloat(document.getElementById('zz').value) || 0.95,
                pay: parseFloat(document.getElementById('pay').value) || 150,
                start: parseFloat(document.getElementById('start').value) || 0,
                tiers: document.getElementById('tiers').value.split('\n').map(l => {
                    const p = l.split(':').map(Number);
                    return { limit: p[0], cent: p[1]/100, base: p[2] };
                })
            };

            const meterIn = document.getElementById('newMeter');
            const lastVal = db.length > 0 ? db[db.length-1].m : 0;
            document.getElementById('saveBtn').disabled = meterIn.value === "" || parseFloat(meterIn.value) < lastVal;

            const curM = meterIn.value !== "" ? parseFloat(meterIn.value) : (db.length > 0 ? lastVal : null);
            const curD = document.getElementById('newDate').value;

            if (curM && db.length > 0) {
                const totalKwh = (curM - cfg.start) * cfg.bw * cfg.zz;
                const daysTotal = Math.max(1, (new Date(curD) - new Date(db[0].d)) / 86400000);
                const globalAvg = (curM - db[0].m) / daysTotal;
                
                const tier = getActiveTier(totalKwh, cfg.tiers);
                const currentCost = (totalKwh * tier.cent) + ((tier.base * 12 / 365) * daysTotal);
                
                // --- LOGIK 1: AKTUELLES SALDO ---
                const sPay = document.getElementById('firstPayDate').value ? new Date(document.getElementById('firstPayDate').value) : new Date(db[0].d);
                let pCnt = 0; let cD = new Date(sPay);
                while(cD <= new Date(curD) && pCnt < 12) { 
                    pCnt++; 
                    cD.setMonth(cD.getMonth()+1); 
                }
                const saldo = (pCnt * cfg.pay) - currentCost;
                
                const outS = document.getElementById('outSaldo');
                outS.innerText = saldo.toLocaleString('de-DE', {style:'currency', currency:'EUR'});
                outS.style.color = saldo >= 0 ? "var(--ios-green)" : "var(--ios-red)";
                
                const bS = document.getElementById('badgeSaldo');
                bS.innerText = saldo >= 0 ? "Im Guthaben" : "In der Nachzahlung";
                bS.className = "badge " + (saldo >= 0 ? "bg-good" : "bg-danger");
                document.getElementById('cardSaldo').style.borderColor = saldo >= 0 ? "var(--ios-green)" : "var(--ios-red)";

                // --- LOGIK 2: PROGNOSE & AMPEL ---
                const yearKwh = (globalAvg * 365) * cfg.bw * cfg.zz;
                const yTier = getActiveTier(yearKwh, cfg.tiers);
                const yearCost = (yearKwh * yTier.cent) + (yTier.base * 12);
                document.getElementById('outYear').innerText = yearCost.toLocaleString('de-DE', {style:'currency', currency:'EUR'});
                
                const ratio = yearCost / (cfg.pay * 12);
                let tCl, tTx;
                
                if (ratio > 1.15) { 
                    tCl = "bg-danger"; tTx = "Abschlag zu niedrig!"; 
                } else if (ratio > 1.05) { 
                    tCl = "bg-warn"; tTx = "Knappe Deckung"; 
                } else if (ratio < 0.85) { 
                    tCl = "bg-info"; tTx = "Abschlag zu hoch"; 
                } else { 
                    tCl = "bg-good"; tTx = "Abschlag ideal"; 
                }
                
                const bT = document.getElementById('badgeTrend');
                bT.className = "badge " + tCl;
                bT.innerText = tTx;
                
                // Kartenrand einf√§rben
                const trendColor = (ratio > 1.15) ? "var(--ios-red)" : (ratio > 1.05 ? "var(--ios-orange)" : (ratio < 0.85 ? "var(--ios-blue)" : "var(--ios-green)"));
                document.getElementById('cardTrend').style.borderColor = trendColor;

                // --- TABELLEN RENDERING ---
                const tbody = document.getElementById('historyTable');
                tbody.innerHTML = '';
                for (let i = db.length - 1; i >= 0; i--) {
                    let trendIcon = "‚Üí"; let trendClass = "";
                    if (i > 0) {
                        const daysDiff = (new Date(db[i].d) - new Date(db[i-1].d)) / 86400000;
                        const dailyV = (db[i].m - db[i-1].m) / daysDiff;
                        if (dailyV > globalAvg * 1.15) { trendIcon = "‚ÜóÔ∏é"; trendClass = "trend-up"; }
                        else if (dailyV < globalAvg * 0.85) { trendIcon = "‚ÜòÔ∏é"; trendClass = "trend-down"; }
                    }
                    tbody.innerHTML += `<tr>
                        <td>${new Date(db[i].d).toLocaleDateString('de-DE')}</td>
                        <td>${db[i].m.toFixed(2)}</td>
                        <td class="${trendClass}">${trendIcon}</td>
                        <td><button style="color:red; background:none; width:auto; margin:0; padding:0;" onclick="delEntry(${db[i].id})">‚úï</button></td>
                    </tr>`;
                }
                drawChart();
            }
        }

        function drawChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const labels = [], data = [];
            for (let i = 1; i < db.length; i++) {
                const diffD = (new Date(db[i].d) - new Date(db[i-1].d)) / 86400000;
                labels.push(new Date(db[i].d).toLocaleDateString());
                data.push(diffD > 0 ? ((db[i].m - db[i-1].m) / diffD).toFixed(2) : 0);
            }
            document.getElementById('chartWrap').style.width = Math.max(window.innerWidth - 90, db.length * 55) + 'px';
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ data, backgroundColor: '#007AFF', borderRadius: 6 }] },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
            });
        }

        function doSave() {
            const m = parseFloat(document.getElementById('newMeter').value);
            const d = document.getElementById('newDate').value;
            if (!m || !d) return;
            db.push({ d, m, id: Date.now() });
            db.sort((a,b) => new Date(a.d) - new Date(b.d));
            localStorage.setItem('gas_db_v8', JSON.stringify(db));
            document.getElementById('newMeter').value = "";
            const t = document.getElementById('toast'); 
            t.classList.add('visible'); 
            setTimeout(() => t.classList.remove('visible'), 2500);
            liveUpdate();
        }

        function delEntry(id) { if(confirm("Eintrag wirklich l√∂schen?")) { db = db.filter(x => x.id !== id); localStorage.setItem('gas_db_v8', JSON.stringify(db)); liveUpdate(); } }
        function doExport() { navigator.clipboard.writeText(JSON.stringify(db)).then(() => alert("Daten in Zwischenablage!")); }
        function doImport() { const s = prompt("Backup-JSON einf√ºgen:"); if(s) { db = JSON.parse(s); localStorage.setItem('gas_db_v8', JSON.stringify(db)); liveUpdate(); } }
        function doReset() { if(confirm("SYSTEM-RESET?") && prompt("Best√§tigen mit L√ñSCHEN")==="L√ñSCHEN") { localStorage.clear(); location.reload(); } }
        function updatePin() { localStorage.setItem('gas_pin_v8', document.getElementById('pinSetting').value); }
        function unlockApp() { if(document.getElementById('pinInput').value === localStorage.getItem('gas_pin_v8')) { document.getElementById('lockScreen').style.display = "none"; liveUpdate(); } else { alert("Falscher PIN"); } }

        window.onload = () => {
            ['bw', 'zz', 'pay', 'start', 'tiers', 'firstPayDate'].forEach(id => {
                const v = localStorage.getItem('gas_pref_' + id); 
                if(v) document.getElementById(id).value = v;
            });
            document.getElementById('newDate').valueAsDate = new Date();
            if(localStorage.getItem('gas_pin_v8')) {
                document.getElementById('lockScreen').style.display = "flex";
            } else {
                liveUpdate();
            }
        };
    </script>
</body>
</html>